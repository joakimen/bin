#!/usr/bin/env bb
(require '[babashka.process :as p]
         '[clojure.string :as str])

(defn run [cmd]
  (let [{:keys [out err exit]} (p/sh cmd)]
    (when-not (zero? exit)
      (throw (ex-info (str/trim err) {:babashka/exit exit})))
    (str/trim out)))

;; define multimethod
(defmulti action (fn [project] [(:type project)]))

;; maven
(defmethod action ["maven"] [_]
  (p/shell "mvn spotless:check"))

;; TODO: defmethods should use p/shell {:continue true} to avoid printing stack traces

;; go
(defmethod action ["go"] [_]
  (p/shell "go test -v"))

;; default
(defmethod action :default [project]
  (throw (IllegalArgumentException.
          (str "unsupported project type: " project))))

(action {:type (run "guess-project")})

(comment
  (action {:type "maven"})

  (let [project-type (run "guess-project")]
    (println "project:" project-type)))
